# 企查查股权穿透图复刻项目需求文档

## 1. 项目概述

### 1.1 项目目标
基于 Vue3 + AntV G6 技术栈，复刻企查查的股权穿透图功能，实现企业股权关系的可视化展示。

### 1.2 技术栈
- **前端框架**: Vue 3
- **图形库**: AntV G6
- **构建工具**: Vite
- **样式**: CSS3 / SCSS
- **包管理**: npm/yarn

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 初始加载
- 默认加载节点数据 (`root_node.json`)
- 展示两级股权关系图
- 父节点居中显示
- 子节点按持股比例排列

#### 2.1.2 动态展开/折叠
- **数据结构说明**:
  - `root_node.json` 与 `child_node.json` 的数据结构完全一致
  - `Result.KeyNo` 表示父节点的唯一标识
  - `Result.EquityShareDetail.KeyNo` 表示子节点的唯一标识
  - 父节点点击加号可以展开和折叠其子节点

- **展开逻辑**:
  - 所有 `DetailCount > 0` 的节点都显示"+"按钮，支持展开操作
  - 父节点中 `KeyNo="5208c748aee27261ff5385af07d585df"` 的节点点击展开时加载 `child_node.json` 数据
  - 当子节点的 `KeyNo="e9c0f42b8aef6822aaca315f9132eea4"` 时，点击展开会动态请求 `child_node.json` 加载下一个层级的节点数据
  - 展开子节点后，"+"变为"-"按钮
  - 展开的子节点自动居中显示

- **折叠逻辑**:
  - 点击"-"按钮折叠子节点
  - "-"变回"+"按钮
  - 恢复到展开前的视图状态

#### 2.1.3 自动居中
- 父节点默认居中
- 点击展开的子节点自动移动到画布中央
- 支持平滑的动画过渡效果

### 2.2 数据结构分析

#### 2.2.1 父节点数据结构 (root_node.json)
```json
{
  "Status": 200,
  "Result": {
    "KeyNo": "beac5843a35be1f73c5f65a55ffc47b3",
    "CompanyName": "宁波通商控股集团有限公司",
    "DetailCount": 32,
    "EquityShareDetail": [
      {
        "KeyNo": "5208c748aee27261ff5385af07d585df", // 可展开节点
        "Name": "宁波市水务环境集团股份有限公司",
        "Percent": "88%",
        "DetailCount": 14, // 有子节点
        "ShortStatus": "存续"
      }
    ]
  }
}
```

#### 2.2.2 子节点数据结构 (child_node.json)
```json
{
  "Status": 200,
  "Result": {
    "KeyNo": "5208c748aee27261ff5385af07d585df",
    "CompanyName": "宁波市水务环境集团股份有限公司",
    "DetailCount": 14,
    "EquityShareDetail": [
      {
        "KeyNo": "e9c0f42b8aef6822aaca315f9132eea4",
        "Name": "宁波市宁东水务有限公司",
        "Percent": "100%",
        "DetailCount": 0
      }
    ]
  }
}
```

## 3. UI/UX 设计需求

### 3.1 整体布局
- **排版方向**: 从上到下的树形结构
- **画布**: 支持缩放、拖拽的无限画布
- **响应式**: 适配不同屏幕尺寸

### 3.2 节点样式设计

#### 3.2.1 企业节点
- **形状**: 圆角矩形卡片 (border-radius: 4px)
- **尺寸**: 宽度约 160px，高度约 60px
- **边框**: 1px 实线边框
- **背景色和边框色**: 
  - 普通企业节点: 白色背景 (#ffffff)，蓝色边框 (#1890ff)
  - 选中企业节点: 蓝色背景 (#1890ff)，蓝色边框 (#1890ff)
- **文字颜色**:
  - 普通状态: 黑色文字 (#000000)
  - 选中状态: 白色文字 (#ffffff)
- **内容布局**:
  ```
  ┌─────────────────────┐
  │    公司名称         │
  │                     │
  └─────────────────────┘
  ```
- **文字样式**: 
  - 字体大小: 14px
  - 字体粗细: normal
  - 文字居中显示
  - 超长文字自动换行

#### 3.2.2 自然人节点
- **形状**: 圆形
- **尺寸**: 直径约 80px
- **背景色**: 橙色 (#ff9500)
- **文字颜色**: 白色 (#ffffff)
- **内容**: 显示人名
- **文字样式**: 
  - 字体大小: 14px
  - 字体粗细: normal
  - 文字居中显示

#### 3.2.3 展开/折叠按钮
- **位置**: 节点下方中央
- **形状**: 圆形
- **尺寸**: 直径约 24px
- **样式**: 
  - "+" 按钮: 蓝色背景 (#1890ff)，白色加号
  - "-" 按钮: 灰色背景 (#666666)，白色减号
- **显示条件**: `DetailCount > 0` 的节点显示按钮

#### 3.2.4 投资关系连接线
- **类型**: 折线连接（polyline）
- **连线优化**: 能重合的线尽量重合，减少视觉干扰
- **颜色**: 浅灰色 (#d9d9d9)
- **宽度**: 1px
- **箭头**: 蓝色三角形箭头 (#1890ff)，指向被投资方
- **持股比例标签**:
  - 位置: 折线上适当位置
  - 背景: 白色
  - 文字颜色: 蓝色 (#1890ff)
  - 字体大小: 12px
  - 格式: "XX%"

### 3.3 图例设计
根据截图底部的图例，需要实现以下图例项：

- **当前节点**: 蓝色实心方块 (#1890ff)
- **企业**: 蓝色空心方块，白色填充，蓝色边框 (#1890ff)
- **人员**: 橙色实心圆形 (#ff9500)
- **投资**: 蓝色右箭头 (#1890ff)

图例位置：左下角固定定位
图例样式：
- 背景: 半透明白色 (rgba(255,255,255,0.9))
- 边框: 1px 实线 (#e8e8e8)
- 圆角: 4px
- 内边距: 12px
- 字体大小: 12px
- 字体颜色: #666666

## 4. 交互需求

### 4.1 基础交互
- **节点点击**: 选中节点，高亮显示
- **画布拖拽**: 支持画布平移
- **缩放**: 支持鼠标滚轮缩放
- **双击**: 双击节点居中显示

### 4.2 展开/折叠交互
- **展开动画**: 子节点从父节点位置展开，持续时间 500ms
- **折叠动画**: 子节点收缩到父节点位置，持续时间 300ms
- **居中动画**: 平滑移动到画布中心，持续时间 800ms

### 4.3 状态管理
- 记录展开/折叠状态
- 支持浏览器前进/后退
- 保存用户操作历史

## 5. 技术实现要点

### 5.1 G6 配置
```javascript
const graph = new G6.Graph({
  container: 'container',
  width: window.innerWidth,
  height: window.innerHeight,
  layout: {
    type: 'dagre',
    direction: 'TB', // 从上到下
    rankdir: 'TB',
    nodesep: 100,
    ranksep: 150
  },
  defaultNode: {
    type: 'rect',
    size: [200, 100],
    style: {
      radius: 8,
      fill: '#1890ff',
      stroke: '#1890ff'
    }
  },
  defaultEdge: {
    type: 'polyline',
    style: {
      stroke: '#d9d9d9',
      lineWidth: 1,
      endArrow: {
        path: 'M 0,0 L 8,4 L 8,-4 Z',
        fill: '#1890ff'
      }
    }
  }
});
```

### 5.2 数据转换
```javascript
// 将API数据转换为G6格式
function transformData(apiData) {
  const nodes = [];
  const edges = [];
  
  // 添加根节点
  nodes.push({
    id: apiData.Result.KeyNo,
    label: apiData.Result.CompanyName,
    type: 'company-node',
    data: apiData.Result
  });
  
  // 添加子节点和边
  apiData.Result.EquityShareDetail.forEach(item => {
    nodes.push({
      id: item.KeyNo,
      label: item.Name,
      type: 'company-node',
      data: item
    });
    
    edges.push({
      source: apiData.Result.KeyNo,
      target: item.KeyNo,
      label: item.Percent
    });
  });
  
  return { nodes, edges };
}
```

### 5.3 自定义节点
```javascript
// 企业节点
G6.registerNode('company-node', {
  draw(cfg, group) {
    const isSelected = cfg.selected;
    
    // 主节点矩形
    const rect = group.addShape('rect', {
      attrs: {
        x: -80,
        y: -30,
        width: 160,
        height: 60,
        radius: 4,
        fill: isSelected ? '#1890ff' : '#ffffff',
        stroke: '#1890ff',
        lineWidth: 1
      },
      name: 'main-rect'
    });
    
    // 公司名称
    group.addShape('text', {
      attrs: {
        x: 0,
        y: 0,
        text: cfg.data.Name || cfg.label,
        fontSize: 14,
        fill: isSelected ? '#ffffff' : '#000000',
        textAlign: 'center',
        textBaseline: 'middle',
        fontWeight: 'normal'
      },
      name: 'company-name'
    });
    
    // 展开按钮（如果有子节点）
    if (cfg.data.DetailCount > 0) {
      const expanded = cfg.expanded || false;
      
      group.addShape('circle', {
        attrs: {
          x: 0,
          y: 42,
          r: 12,
          fill: expanded ? '#666666' : '#1890ff',
          cursor: 'pointer'
        },
        name: 'expand-btn'
      });
      
      group.addShape('text', {
        attrs: {
          x: 0,
          y: 42,
          text: expanded ? '-' : '+',
          fontSize: 14,
          fill: '#ffffff',
          textAlign: 'center',
          textBaseline: 'middle',
          cursor: 'pointer',
          fontWeight: 'bold'
        },
        name: 'expand-text'
      });
    }
    
    return rect;
  },
  
  update(cfg, item) {
    const group = item.getContainer();
    const isSelected = cfg.selected;
    
    // 更新主矩形样式
    const rect = group.find(e => e.get('name') === 'main-rect');
    rect.attr({
      fill: isSelected ? '#1890ff' : '#ffffff'
    });
    
    // 更新文字颜色
    const text = group.find(e => e.get('name') === 'company-name');
    text.attr({
      fill: isSelected ? '#ffffff' : '#000000'
    });
    
    // 更新展开按钮状态
    const expandBtn = group.find(e => e.get('name') === 'expand-btn');
    const expandText = group.find(e => e.get('name') === 'expand-text');
    
    if (expandBtn && expandText) {
      const expanded = cfg.expanded || false;
      expandBtn.attr({
        fill: expanded ? '#666666' : '#1890ff'
      });
      expandText.attr({
        text: expanded ? '-' : '+'
      });
    }
  }
});

// 自然人节点
G6.registerNode('person-node', {
  draw(cfg, group) {
    // 圆形背景
    const circle = group.addShape('circle', {
      attrs: {
        x: 0,
        y: 0,
        r: 40,
        fill: '#ff9500',
        stroke: '#ff9500'
      },
      name: 'main-circle'
    });
    
    // 人名
    group.addShape('text', {
      attrs: {
        x: 0,
        y: 0,
        text: cfg.data.Name || cfg.label,
        fontSize: 14,
        fill: '#ffffff',
        textAlign: 'center',
        textBaseline: 'middle',
        fontWeight: 'normal'
      },
      name: 'person-name'
    });
    
    return circle;
  }
});
```

## 6. 性能优化

### 6.1 数据加载
- 懒加载子节点数据
- 缓存已加载的数据
- 支持数据预加载

### 6.2 渲染优化
- 虚拟化大量节点
- 节点复用机制
- 动画性能优化

### 6.3 内存管理
- 及时清理未使用的节点
- 图片资源懒加载
- 事件监听器管理

## 7. 开发计划

### 7.1 第一阶段 (基础功能)
- [ ] 项目初始化和环境搭建
- [ ] 数据结构设计和API封装
- [ ] 基础节点和连线渲染
- [ ] 初始数据加载和展示

### 7.2 第二阶段 (交互功能)
- [ ] 展开/折叠功能实现
- [ ] 动态数据加载
- [ ] 节点居中功能
- [ ] 基础交互优化

### 7.3 第三阶段 (样式优化)
- [ ] 企查查样式复刻
- [ ] 动画效果实现
- [ ] 响应式适配
- [ ] 性能优化

### 7.4 第四阶段 (完善功能)
- [ ] 错误处理和边界情况
- [ ] 用户体验优化
- [ ] 测试和调试
- [ ] 文档完善

## 8. 验收标准

### 8.1 功能验收
- ✅ 正确加载和显示父节点数据
- ✅ 特定节点显示展开按钮
- ✅ 点击展开按钮加载子节点数据
- ✅ 展开/折叠状态正确切换
- ✅ 节点自动居中功能正常
- ✅ 节点选中状态切换正常

### 8.2 样式验收
- ✅ 企业节点样式与截图一致（白底蓝边，选中时蓝底白字）
- ✅ 自然人节点样式与截图一致（橙色圆形）
- ✅ 投资箭头和持股比例标签样式正确
- ✅ 展开/折叠按钮样式和位置正确
- ✅ 图例样式和内容与截图一致
- ✅ 节点内容仅显示公司名称，不显示多余信息
- ✅ 动画效果流畅自然
- ✅ 响应式布局适配良好

### 8.3 性能验收
- ✅ 初始加载时间 < 2秒
- ✅ 展开动画流畅 (60fps)
- ✅ 支持100+节点无卡顿
- ✅ 内存使用合理

## 9. 风险评估

### 9.1 技术风险
- **G6版本兼容性**: 选择稳定版本，做好版本锁定
- **数据结构变化**: 设计灵活的数据适配层
- **性能瓶颈**: 提前做好性能测试和优化方案

### 9.2 业务风险
- **需求变更**: 保持代码结构的可扩展性
- **数据源变化**: 设计统一的数据接口层
- **用户体验**: 持续收集用户反馈并优化

## 10. 后续扩展

### 10.1 功能扩展
- 支持多层级无限展开
- 添加搜索和筛选功能
- 支持导出图片和PDF
- 添加节点详情弹窗

### 10.2 技术扩展
- 支持服务端渲染 (SSR)
- 添加单元测试和E2E测试
- 集成CI/CD流程
- 支持多主题切换
